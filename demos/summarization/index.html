<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Summarization | AI-KON Demos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 6px solid #f3f4f6;
            border-top: 6px solid #6366f1;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <h2 class="text-white text-xl font-semibold mt-4">Loading Summarization Model...</h2>
        <p class="text-white text-sm mt-2">This may take a minute</p>
        <progress id="progress-bar" value="0" max="100" class="w-64 mt-4 h-2"></progress>
        <p id="progress-text" class="text-white text-sm mt-2">0%</p>
    </div>

    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">üìù Text Summarization</h1>
                    <p class="text-sm text-gray-600">AI-powered text summarization</p>
                </div>
                <a href="../" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                    ‚Üê Back to Demos
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left: Input -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Input Text</h2>

                <textarea
                    id="input-text"
                    rows="15"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none"
                    placeholder="Paste your text here to summarize..."
                >The tower is 324 metres (1,063 ft) tall, about the same height as an 81-storey building, and the tallest structure in Paris. Its base is square, measuring 125 metres (410 ft) on each side. During its construction, the Eiffel Tower surpassed the Washington Monument to become the tallest man-made structure in the world, a title it held for 41 years until the Chrysler Building in New York City was finished in 1930. It was the first structure to reach a height of 300 metres. Due to the addition of a broadcasting aerial at the top of the tower in 1957, it is now taller than the Chrysler Building by 5.2 metres (17 ft). Excluding transmitters, the Eiffel Tower is the second tallest free-standing structure in France after the Millau Viaduct.</textarea>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Summary Length</label>
                    <select id="length-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="short">Short (~50 words)</option>
                        <option value="medium" selected>Medium (~100 words)</option>
                        <option value="long">Long (~150 words)</option>
                    </select>
                </div>

                <button
                    id="summarize-btn"
                    class="w-full mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 font-medium"
                >
                    Summarize Text
                </button>

                <div class="mt-4 space-y-2">
                    <h3 class="text-sm font-medium text-gray-700">Example Texts:</h3>
                    <button class="example-btn w-full text-left text-xs bg-gray-100 hover:bg-gray-200 p-2 rounded">
                        Eiffel Tower (Wikipedia)
                    </button>
                    <button class="example-btn w-full text-left text-xs bg-gray-100 hover:bg-gray-200 p-2 rounded" data-text="Artificial intelligence (AI) is intelligence demonstrated by machines, in contrast to the natural intelligence displayed by humans and animals. Leading AI textbooks define the field as the study of intelligent agents: any device that perceives its environment and takes actions that maximize its chance of successfully achieving its goals. Colloquially, the term artificial intelligence is often used to describe machines (or computers) that mimic cognitive functions that humans associate with the human mind, such as learning and problem solving.">
                        AI Definition
                    </button>
                </div>
            </div>

            <!-- Right: Output -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Summary</h2>

                <div id="summary-result" class="w-full min-h-64 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    <p class="text-gray-500 text-center mt-20">Summary will appear here...</p>
                </div>

                <div class="mt-4 grid grid-cols-3 gap-2">
                    <div class="bg-indigo-50 p-3 rounded-lg text-center">
                        <p class="text-xs text-indigo-600">Original</p>
                        <p id="original-words" class="text-lg font-bold text-indigo-900">0</p>
                        <p class="text-xs text-indigo-600">words</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg text-center">
                        <p class="text-xs text-green-600">Summary</p>
                        <p id="summary-words" class="text-lg font-bold text-green-900">0</p>
                        <p class="text-xs text-green-600">words</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg text-center">
                        <p class="text-xs text-purple-600">Reduction</p>
                        <p id="reduction-percent" class="text-lg font-bold text-purple-900">0%</p>
                    </div>
                </div>

                <button id="copy-btn" class="w-full mt-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium hidden">
                    üìã Copy Summary
                </button>
            </div>
        </div>

        <!-- Info -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
                <strong>Note:</strong> This demo uses DistilBART for text summarization.
                Best results with articles, news, or long-form content. All processing happens in your browser!
            </p>
        </div>
    </div>

    <script type="module">
        // Check WebGPU support first
        if (!navigator.gpu) {
            window.location.href = '../fallback.html';
            throw new Error('WebGPU not supported');
        }

        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.7.5';

        env.allowLocalModels = false;

        const loadingOverlay = document.getElementById('loading-overlay');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const inputText = document.getElementById('input-text');
        const lengthSelect = document.getElementById('length-select');
        const summaryResult = document.getElementById('summary-result');
        const summarizeBtn = document.getElementById('summarize-btn');
        const copyBtn = document.getElementById('copy-btn');
        const originalWords = document.getElementById('original-words');
        const summaryWords = document.getElementById('summary-words');
        const reductionPercent = document.getElementById('reduction-percent');
        const exampleBtns = document.querySelectorAll('.example-btn');

        let summarizer;

        // Initialize model
        async function initModel() {
            try {
                summarizer = await pipeline('summarization', 'Xenova/distilbart-cnn-6-6', {
                    device: 'webgpu',
                    progress_callback: (progress) => {
                        if (progress.status === 'progress') {
                            const percent = Math.round(progress.progress);
                            progressBar.value = percent;
                            progressText.textContent = percent + '%';
                        }
                    }
                });
                loadingOverlay.style.display = 'none';
                console.log('Model loaded');
            } catch (error) {
                console.error('Failed to load model:', error);
                const errorDetails = error.message || 'Unknown error';

                let helpText = 'Please refresh the page and try again.';
                if (errorDetails.includes('gpu')) {
                    helpText = 'Your browser may not fully support WebGPU. Please update to the latest Chrome/Edge version.';
                } else if (errorDetails.includes('network') || errorDetails.includes('fetch')) {
                    helpText = 'Network error while downloading model. Please check your connection and try again.';
                }

                loadingOverlay.innerHTML = `
                    <div class="text-center px-8">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h2 class="text-white text-xl font-semibold mb-2">Failed to Load Model</h2>
                        <p class="text-white text-sm mb-2">${helpText}</p>
                        <p class="text-white text-xs opacity-75 mb-4">${errorDetails}</p>
                        <button onclick="window.location.reload()" class="px-6 py-2 bg-white text-indigo-600 rounded-lg hover:bg-gray-100 font-medium">
                            Try Again
                        </button>
                        <a href="../" class="ml-2 px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium inline-block">
                            Back to Demos
                        </a>
                    </div>
                `;
            }
        }

        function countWords(text) {
            return text.trim().split(/\s+/).filter(w => w.length > 0).length;
        }

        // Summarize text
        async function summarize() {
            if (!summarizer) return;

            const text = inputText.value.trim();
            if (!text) {
                alert('Please enter text to summarize');
                return;
            }

            const origWords = countWords(text);
            if (origWords < 50) {
                alert('Text is too short to summarize. Please enter at least 50 words.');
                return;
            }

            const lengthParams = {
                'short': { min_length: 20, max_length: 50 },
                'medium': { min_length: 50, max_length: 120 },
                'long': { min_length: 100, max_length: 200 }
            };

            const params = lengthParams[lengthSelect.value];

            summarizeBtn.disabled = true;
            summarizeBtn.textContent = 'Summarizing...';
            summaryResult.innerHTML = '<div class="text-center mt-20"><div class="inline-block w-8 h-8 border-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div><p class="text-gray-600 mt-2">Generating summary...</p></div>';
            copyBtn.classList.add('hidden');

            try {
                const result = await summarizer(text, {
                    max_length: params.max_length,
                    min_length: params.min_length
                });

                const summary = result[0].summary_text;
                summaryResult.innerHTML = `<p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${summary}</p>`;

                const summWords = countWords(summary);
                originalWords.textContent = origWords;
                summaryWords.textContent = summWords;
                reductionPercent.textContent = Math.round((1 - summWords / origWords) * 100) + '%';

                copyBtn.classList.remove('hidden');

            } catch (error) {
                console.error('Summarization error:', error);
                summaryResult.innerHTML = '<p class="text-red-600 text-center mt-20">Summarization failed. Please try again with different text.</p>';
            } finally {
                summarizeBtn.disabled = false;
                summarizeBtn.textContent = 'Summarize Text';
            }
        }

        // Event listeners
        summarizeBtn.addEventListener('click', summarize);

        copyBtn.addEventListener('click', () => {
            const text = summaryResult.textContent;
            navigator.clipboard.writeText(text);
            copyBtn.textContent = '‚úì Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'üìã Copy Summary';
            }, 2000);
        });

        exampleBtns.forEach((btn, idx) => {
            btn.addEventListener('click', () => {
                if (idx === 1 && btn.dataset.text) {
                    inputText.value = btn.dataset.text;
                }
                // First button keeps the default text
            });
        });

        // Initialize
        initModel();
    </script>
</body>
</html>
