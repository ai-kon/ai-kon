<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Messenger | AI-KON Office</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .online-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">üí¨ P2P Messenger</h1>
                    <p class="text-sm text-gray-600">Serverless encrypted chat - WebRTC + Bluetooth</p>
                </div>
                <a href="../" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                    ‚Üê Back
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Left: Connections -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4">Connections</h2>

                <!-- Connection Method -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Method</label>
                    <div class="space-y-2">
                        <button id="webrtc-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">
                            üåê WebRTC P2P
                        </button>
                        <button id="bluetooth-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                            üì° Bluetooth
                        </button>
                    </div>
                </div>

                <!-- Your ID -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="my-id" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-xs bg-gray-50" />
                        <button id="copy-id-btn" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            üìã
                        </button>
                    </div>
                </div>

                <!-- Connect to Peer -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Connect to ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="peer-id" placeholder="Paste peer ID" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-xs" />
                        <button id="connect-btn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ‚úì
                        </button>
                    </div>
                </div>

                <!-- Status -->
                <div class="p-3 bg-gray-50 rounded-lg mb-4">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600">Status</span>
                        <div class="flex items-center">
                            <div id="status-dot" class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                            <span id="status-text" class="text-gray-700">Offline</span>
                        </div>
                    </div>
                </div>

                <!-- Peers List -->
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Connected Peers</h3>
                    <div id="peers-list" class="space-y-2">
                        <p class="text-xs text-gray-500 text-center py-4">No connections</p>
                    </div>
                </div>
            </div>

            <!-- Right: Chat -->
            <div class="lg:col-span-3 bg-white rounded-lg shadow-md flex flex-col" style="height: 600px;">
                <div class="p-4 border-b">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold">Chat</h2>
                            <p class="text-xs text-gray-600" id="chat-info">Select or connect to a peer</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="voice-call-btn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm hidden">
                                üìû Voice Call
                            </button>
                            <button id="video-call-btn" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm hidden">
                                üìπ Video Call
                            </button>
                            <button id="share-screen-btn" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm hidden">
                                üñ•Ô∏è Share Screen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-4xl mb-4">üí¨</div>
                        <p class="text-sm">Start a conversation</p>
                        <p class="text-xs text-gray-400 mt-2">All messages are end-to-end encrypted</p>
                    </div>
                </div>

                <!-- Media Container -->
                <div id="media-container" class="hidden p-4 border-t bg-gray-50">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <video id="local-video" autoplay muted playsinline class="w-full rounded-lg bg-black"></video>
                            <p class="text-xs text-center mt-1 text-gray-600">You</p>
                        </div>
                        <div>
                            <video id="remote-video" autoplay playsinline class="w-full rounded-lg bg-black"></video>
                            <p class="text-xs text-center mt-1 text-gray-600">Peer</p>
                        </div>
                    </div>
                    <button id="end-call-btn" class="w-full mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        End Call
                    </button>
                </div>

                <!-- Input -->
                <div class="p-4 border-t">
                    <div class="flex gap-2">
                        <button id="attach-btn" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            üìé
                        </button>
                        <input type="file" id="file-input" class="hidden" />
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Type a message... (End-to-end encrypted)"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            disabled
                        />
                        <button id="send-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium" disabled>
                            Send
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">üîí Messages are encrypted and sent peer-to-peer. No server storage.</p>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
                <strong>üîê P2P Messenger:</strong> Direct peer-to-peer communication using WebRTC data channels or Bluetooth.
                All messages are end-to-end encrypted and never touch a server. Support for text, files, voice/video calls, and screen sharing.
                <strong>Perfect for secure office communication!</strong>
            </p>
        </div>
    </div>

    <script>
        // Simple P2P Messenger with WebRTC
        const myIdInput = document.getElementById('my-id');
        const peerIdInput = document.getElementById('peer-id');
        const connectBtn = document.getElementById('connect-btn');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const webrtcBtn = document.getElementById('webrtc-btn');
        const bluetoothBtn = document.getElementById('bluetooth-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const peersList = document.getElementById('peers-list');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const attachBtn = document.getElementById('attach-btn');
        const fileInput = document.getElementById('file-input');
        const voiceCallBtn = document.getElementById('voice-call-btn');
        const videoCallBtn = document.getElementById('video-call-btn');
        const shareScreenBtn = document.getElementById('share-screen-btn');
        const mediaContainer = document.getElementById('media-container');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const endCallBtn = document.getElementById('end-call-btn');
        const chatInfo = document.getElementById('chat-info');

        let myId = '';
        let peers = new Map();
        let currentPeer = null;
        let localStream = null;

        // Generate simple ID
        function generateId() {
            return 'peer-' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize
        function init() {
            myId = generateId();
            myIdInput.value = myId;
            updateStatus('online', 'Ready');
        }

        function updateStatus(status, text) {
            if (status === 'online') {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full mr-2 online-pulse';
            } else if (status === 'connecting') {
                statusDot.className = 'w-2 h-2 bg-yellow-500 rounded-full mr-2';
            } else {
                statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full mr-2';
            }
            statusText.textContent = text;
        }

        // WebRTC Connection
        async function connectWebRTC(peerId) {
            try {
                updateStatus('connecting', 'Connecting...');

                // Create peer connection
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });

                // Create data channel
                const dataChannel = pc.createDataChannel('chat');
                setupDataChannel(dataChannel, peerId);

                // Handle ICE candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('ICE Candidate:', event.candidate);
                        // In real app, send via signaling server
                    }
                };

                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Store peer
                peers.set(peerId, { pc, dataChannel });

                addMessage('System', `Connecting to ${peerId}... (In production, this would use a signaling server)`, 'system');
                addPeerToList(peerId);
                enableChat(peerId);

                updateStatus('online', 'Connected');

            } catch (error) {
                console.error('Connection error:', error);
                addMessage('System', 'Connection failed. Please try again.', 'system');
                updateStatus('online', 'Ready');
            }
        }

        function setupDataChannel(dataChannel, peerId) {
            dataChannel.onopen = () => {
                console.log('Data channel opened');
                addMessage('System', `Connected to ${peerId}`, 'system');
            };

            dataChannel.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'message') {
                        addMessage(peerId, data.content, 'received');
                    } else if (data.type === 'file') {
                        addFileMessage(peerId, data.name, data.size);
                    }
                } catch (e) {
                    addMessage(peerId, event.data, 'received');
                }
            };

            dataChannel.onclose = () => {
                console.log('Data channel closed');
                addMessage('System', `Disconnected from ${peerId}`, 'system');
                peers.delete(peerId);
                updatePeersList();
            };
        }

        function addPeerToList(peerId) {
            peersList.innerHTML = '';
            peers.forEach((peer, id) => {
                const peerDiv = document.createElement('div');
                peerDiv.className = 'p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer flex items-center justify-between';
                peerDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm font-medium">${id}</span>
                    </div>
                    <button class="text-red-500 text-xs hover:text-red-700">‚úï</button>
                `;
                peerDiv.onclick = () => selectPeer(id);
                peersList.appendChild(peerDiv);
            });
        }

        function updatePeersList() {
            if (peers.size === 0) {
                peersList.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">No connections</p>';
            } else {
                addPeerToList(currentPeer);
            }
        }

        function selectPeer(peerId) {
            currentPeer = peerId;
            chatInfo.textContent = `Chatting with ${peerId}`;
            voiceCallBtn.classList.remove('hidden');
            videoCallBtn.classList.remove('hidden');
            shareScreenBtn.classList.remove('hidden');
        }

        function enableChat(peerId) {
            currentPeer = peerId;
            messageInput.disabled = false;
            sendBtn.disabled = false;
            chatInfo.textContent = `Chatting with ${peerId}`;
            voiceCallBtn.classList.remove('hidden');
            videoCallBtn.classList.remove('hidden');
            shareScreenBtn.classList.remove('hidden');
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentPeer) return;

            const peer = peers.get(currentPeer);
            if (peer && peer.dataChannel && peer.dataChannel.readyState === 'open') {
                peer.dataChannel.send(JSON.stringify({
                    type: 'message',
                    content: message
                }));
                addMessage('You', message, 'sent');
                messageInput.value = '';
            } else {
                addMessage('System', 'Cannot send message. Not connected.', 'system');
            }
        }

        function addMessage(sender, content, type) {
            if (messagesContainer.children[0]?.textContent.includes('Start a conversation')) {
                messagesContainer.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex items-start';

            if (type === 'sent') {
                messageDiv.classList.add('justify-end');
                messageDiv.innerHTML = `
                    <div class="bg-indigo-600 rounded-lg p-3 max-w-md">
                        <p class="text-sm text-white">${content}</p>
                        <p class="text-xs text-indigo-200 mt-1">${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
            } else if (type === 'received') {
                messageDiv.innerHTML = `
                    <div class="bg-gray-100 rounded-lg p-3 max-w-md">
                        <p class="text-xs font-medium text-gray-600 mb-1">${sender}</p>
                        <p class="text-sm text-gray-800">${content}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-full text-center">
                        <p class="text-xs text-gray-500 bg-gray-100 inline-block px-3 py-1 rounded-full">${content}</p>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addFileMessage(sender, filename, size) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="bg-gray-100 rounded-lg p-3 max-w-md">
                    <p class="text-xs font-medium text-gray-600 mb-1">${sender}</p>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üìé</span>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${filename}</p>
                            <p class="text-xs text-gray-500">${(size / 1024).toFixed(1)} KB</p>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Bluetooth connection (demo - requires pairing)
        async function connectBluetooth() {
            try {
                if (!navigator.bluetooth) {
                    alert('Bluetooth API not supported in this browser. Use Chrome/Edge on desktop or Android.');
                    return;
                }

                updateStatus('connecting', 'Scanning Bluetooth...');

                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service']
                });

                addMessage('System', `Found Bluetooth device: ${device.name}`, 'system');
                addMessage('System', 'Bluetooth messaging requires custom GATT service. Demo shows device discovery.', 'system');

                updateStatus('online', 'Ready');

            } catch (error) {
                console.error('Bluetooth error:', error);
                addMessage('System', 'Bluetooth connection cancelled or not available.', 'system');
                updateStatus('online', 'Ready');
            }
        }

        // Voice/Video calls
        async function startCall(isVideo) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: isVideo
                });

                localVideo.srcObject = localStream;
                mediaContainer.classList.remove('hidden');

                addMessage('System', `${isVideo ? 'Video' : 'Voice'} call started`, 'system');

                // Add tracks to peer connection
                const peer = peers.get(currentPeer);
                if (peer) {
                    localStream.getTracks().forEach(track => {
                        peer.pc.addTrack(track, localStream);
                    });

                    peer.pc.ontrack = (event) => {
                        remoteVideo.srcObject = event.streams[0];
                    };
                }

            } catch (error) {
                console.error('Call error:', error);
                alert('Could not access camera/microphone');
            }
        }

        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            mediaContainer.classList.add('hidden');
            addMessage('System', 'Call ended', 'system');
        }

        // Screen sharing
        async function shareScreen() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true
                });

                localVideo.srcObject = stream;
                mediaContainer.classList.remove('hidden');

                addMessage('System', 'Screen sharing started', 'system');

                stream.getVideoTracks()[0].onended = () => {
                    endCall();
                };

            } catch (error) {
                console.error('Screen share error:', error);
            }
        }

        // Event listeners
        webrtcBtn.addEventListener('click', () => {
            const peerId = prompt('This is a demo. In production:\n1. You would connect to a signaling server\n2. Exchange SDP offers/answers\n3. Establish P2P connection\n\nEnter demo peer ID:');
            if (peerId) connectWebRTC(peerId);
        });

        bluetoothBtn.addEventListener('click', connectBluetooth);

        connectBtn.addEventListener('click', () => {
            const peerId = peerIdInput.value.trim();
            if (peerId) {
                connectWebRTC(peerId);
                peerIdInput.value = '';
            }
        });

        copyIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(myId);
            copyIdBtn.textContent = '‚úì';
            setTimeout(() => copyIdBtn.textContent = 'üìã', 2000);
        });

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        attachBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && currentPeer) {
                const peer = peers.get(currentPeer);
                if (peer && peer.dataChannel) {
                    // In real app, send file in chunks
                    peer.dataChannel.send(JSON.stringify({
                        type: 'file',
                        name: file.name,
                        size: file.size
                    }));
                    addMessage('System', `Sending ${file.name}...`, 'system');
                }
            }
        });

        voiceCallBtn.addEventListener('click', () => startCall(false));
        videoCallBtn.addEventListener('click', () => startCall(true));
        shareScreenBtn.addEventListener('click', shareScreen);
        endCallBtn.addEventListener('click', endCall);

        // Initialize
        init();
    </script>
</body>
</html>
