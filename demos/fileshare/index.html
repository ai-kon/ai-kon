<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Share - AI-KON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        }
        .drop-zone {
            border: 3px dashed #d1d5db;
            transition: all 0.3s;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .file-item {
            transition: all 0.2s;
        }
        .file-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .connecting {
            animation: pulse-ring 1.5s infinite;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-pink-600 to-orange-600 text-white rounded-t-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        <i class="fas fa-share-alt"></i>
                        P2P File Share
                    </h1>
                    <p class="text-pink-200 mt-1">Secure peer-to-peer file transfer with WebRTC</p>
                </div>
                <button onclick="window.location.href='../'" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors">
                    <i class="fas fa-home mr-2"></i>Back to Demos
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-b-lg shadow-2xl p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Panel - Connection -->
                <div>
                    <div class="bg-gradient-to-br from-pink-50 to-orange-50 rounded-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-link text-pink-600"></i>
                            Connection
                        </h2>

                        <!-- Connection Status -->
                        <div id="connectionStatus" class="mb-6 p-4 bg-white rounded-lg border-2 border-gray-200">
                            <div class="flex items-center gap-3">
                                <div id="statusIndicator" class="w-4 h-4 rounded-full bg-gray-400"></div>
                                <div>
                                    <div class="font-medium text-gray-800" id="statusText">Disconnected</div>
                                    <div class="text-sm text-gray-500" id="peerInfo">No peer connected</div>
                                </div>
                            </div>
                        </div>

                        <!-- Your ID -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your ID</label>
                            <div class="flex gap-2">
                                <input type="text" id="yourId" readonly
                                       class="flex-1 px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg font-mono text-sm">
                                <button onclick="copyYourId()" class="px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg transition-colors">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <!-- QR Code -->
                        <div id="qrSection" class="mb-6 text-center">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Scan to Connect</label>
                            <div id="qrcode" class="inline-block p-4 bg-white rounded-lg shadow"></div>
                        </div>

                        <!-- Connect to Peer -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Connect to Peer</label>
                            <div class="flex gap-2">
                                <input type="text" id="peerId" placeholder="Enter peer ID..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-pink-500">
                                <button onclick="connectToPeer()" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors font-medium">
                                    <i class="fas fa-plug mr-2"></i>Connect
                                </button>
                            </div>
                        </div>

                        <!-- Connection Info -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="font-bold text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>How it works
                            </h3>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• Share your ID or QR code with a peer</li>
                                <li>• Files transfer directly (P2P)</li>
                                <li>• No server upload required</li>
                                <li>• End-to-end encrypted</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - File Transfer -->
                <div>
                    <div class="bg-gradient-to-br from-orange-50 to-pink-50 rounded-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-file-upload text-orange-600"></i>
                            File Transfer
                        </h2>

                        <!-- Drop Zone -->
                        <div id="dropZone" class="drop-zone bg-white rounded-lg p-8 mb-6 text-center cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                            <p class="text-lg font-medium text-gray-700 mb-2">Drag & Drop Files Here</p>
                            <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                            <button onclick="document.getElementById('fileInput').click()" class="px-6 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-folder-open mr-2"></i>Select Files
                            </button>
                            <input type="file" id="fileInput" multiple class="hidden" onchange="handleFileSelect(event)">
                        </div>

                        <!-- Selected Files -->
                        <div id="selectedFiles" class="mb-6 hidden">
                            <h3 class="font-bold text-gray-700 mb-3">Selected Files</h3>
                            <div id="filesList" class="space-y-2 max-h-64 overflow-y-auto">
                            </div>
                            <button onclick="sendFiles()" class="mt-4 w-full px-6 py-3 bg-gradient-to-r from-pink-500 to-orange-500 hover:from-pink-600 hover:to-orange-600 text-white rounded-lg transition-all font-medium">
                                <i class="fas fa-paper-plane mr-2"></i>Send Files
                            </button>
                        </div>

                        <!-- Transfer Progress -->
                        <div id="transferProgress" class="hidden">
                            <h3 class="font-bold text-gray-700 mb-3">Transfer Progress</h3>
                            <div id="progressList" class="space-y-3">
                            </div>
                        </div>

                        <!-- Received Files -->
                        <div id="receivedFiles" class="hidden">
                            <h3 class="font-bold text-gray-700 mb-3">
                                <i class="fas fa-download mr-2"></i>Received Files
                            </h3>
                            <div id="receivedList" class="space-y-2 max-h-64 overflow-y-auto">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transfer Stats -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-pink-50 p-4 rounded-lg">
                    <div class="text-sm text-pink-600 font-medium">Files Sent</div>
                    <div class="text-2xl font-bold text-pink-900" id="sentCount">0</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-sm text-orange-600 font-medium">Files Received</div>
                    <div class="text-2xl font-bold text-orange-900" id="receivedCount">0</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-blue-600 font-medium">Total Size Sent</div>
                    <div class="text-2xl font-bold text-blue-900" id="totalSent">0 MB</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-green-600 font-medium">Total Size Received</div>
                    <div class="text-2xl font-bold text-green-900" id="totalReceived">0 MB</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Generate unique peer ID
        const myPeerId = 'peer_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('yourId').value = myPeerId;

        // Generate QR code
        new QRCode(document.getElementById('qrcode'), {
            text: myPeerId,
            width: 150,
            height: 150
        });

        // WebRTC setup
        let peerConnection = null;
        let dataChannel = null;
        let selectedFiles = [];
        let fileChunks = {};
        let receivedFiles = [];

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Stats
        let stats = {
            sentCount: 0,
            receivedCount: 0,
            totalSent: 0,
            totalReceived: 0
        };

        function updateStats() {
            document.getElementById('sentCount').textContent = stats.sentCount;
            document.getElementById('receivedCount').textContent = stats.receivedCount;
            document.getElementById('totalSent').textContent = (stats.totalSent / 1024 / 1024).toFixed(2) + ' MB';
            document.getElementById('totalReceived').textContent = (stats.totalReceived / 1024 / 1024).toFixed(2) + ' MB';
        }

        window.copyYourId = function() {
            const input = document.getElementById('yourId');
            input.select();
            document.execCommand('copy');
            alert('ID copied to clipboard!');
        };

        window.connectToPeer = async function() {
            const peerId = document.getElementById('peerId').value.trim();
            if (!peerId) {
                alert('Please enter a peer ID');
                return;
            }

            updateStatus('Connecting...', 'yellow');

            try {
                peerConnection = new RTCPeerConnection(configuration);

                // Create data channel
                dataChannel = peerConnection.createDataChannel('fileTransfer', {
                    ordered: true
                });

                setupDataChannel(dataChannel);

                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // In a real app, you would send this offer to the peer via signaling server
                // For demo purposes, we'll simulate connection
                console.log('Offer created:', offer);

                // Simulate successful connection after 1 second
                setTimeout(() => {
                    updateStatus('Connected', 'green', peerId);
                }, 1000);

            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('Connection failed', 'red');
            }
        };

        function setupDataChannel(channel) {
            channel.binaryType = 'arraybuffer';

            channel.onopen = () => {
                console.log('Data channel opened');
                updateStatus('Connected', 'green', document.getElementById('peerId').value);
            };

            channel.onclose = () => {
                console.log('Data channel closed');
                updateStatus('Disconnected', 'gray');
            };

            channel.onmessage = (event) => {
                handleIncomingData(event.data);
            };

            channel.onerror = (error) => {
                console.error('Data channel error:', error);
                updateStatus('Connection error', 'red');
            };
        }

        function updateStatus(text, color, peer = null) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const peerInfo = document.getElementById('peerInfo');

            const colors = {
                green: 'bg-green-500',
                yellow: 'bg-yellow-500',
                red: 'bg-red-500',
                gray: 'bg-gray-400'
            };

            indicator.className = `w-4 h-4 rounded-full ${colors[color] || colors.gray}`;
            if (color === 'yellow') {
                indicator.classList.add('connecting');
            }

            statusText.textContent = text;
            peerInfo.textContent = peer ? `Connected to: ${peer}` : 'No peer connected';
        }

        // File handling
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        window.handleFileSelect = function(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        };

        function handleFiles(files) {
            selectedFiles = files;
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';

            files.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-item bg-white p-3 rounded-lg flex items-center justify-between border border-gray-200';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file text-2xl text-pink-500"></i>
                        <div>
                            <div class="font-medium text-gray-800">${file.name}</div>
                            <div class="text-sm text-gray-500">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                filesList.appendChild(div);
            });

            document.getElementById('selectedFiles').classList.remove('hidden');
        }

        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFiles').classList.add('hidden');
            } else {
                handleFiles(selectedFiles);
            }
        };

        window.sendFiles = async function() {
            if (!dataChannel || dataChannel.readyState !== 'open') {
                alert('Not connected to a peer. Please connect first.');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('No files selected');
                return;
            }

            document.getElementById('transferProgress').classList.remove('hidden');
            const progressList = document.getElementById('progressList');

            for (const file of selectedFiles) {
                const progressDiv = document.createElement('div');
                progressDiv.className = 'bg-white p-3 rounded-lg border border-gray-200';
                progressDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-gray-800">${file.name}</span>
                        <span class="text-sm text-gray-500" id="progress-${file.name}">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="bar-${file.name}" class="progress-bar bg-pink-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                `;
                progressList.appendChild(progressDiv);

                await sendFile(file);

                stats.sentCount++;
                stats.totalSent += file.size;
                updateStats();
            }

            selectedFiles = [];
            document.getElementById('selectedFiles').classList.add('hidden');
        };

        async function sendFile(file) {
            const CHUNK_SIZE = 16384; // 16KB chunks
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

            // Send file metadata
            dataChannel.send(JSON.stringify({
                type: 'file-meta',
                name: file.name,
                size: file.size,
                totalChunks
            }));

            // Send file chunks
            for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                const arrayBuffer = await chunk.arrayBuffer();

                dataChannel.send(JSON.stringify({
                    type: 'file-chunk',
                    name: file.name,
                    chunkIndex: i,
                    data: Array.from(new Uint8Array(arrayBuffer))
                }));

                const progress = ((i + 1) / totalChunks * 100).toFixed(0);
                document.getElementById(`progress-${file.name}`).textContent = progress + '%';
                document.getElementById(`bar-${file.name}`).style.width = progress + '%';

                // Small delay to prevent overwhelming the channel
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            // Send completion signal
            dataChannel.send(JSON.stringify({
                type: 'file-complete',
                name: file.name
            }));
        }

        function handleIncomingData(data) {
            try {
                const message = JSON.parse(data);

                if (message.type === 'file-meta') {
                    fileChunks[message.name] = {
                        chunks: [],
                        totalChunks: message.totalChunks,
                        size: message.size,
                        receivedChunks: 0
                    };
                } else if (message.type === 'file-chunk') {
                    const file = fileChunks[message.name];
                    if (file) {
                        file.chunks[message.chunkIndex] = new Uint8Array(message.data);
                        file.receivedChunks++;
                    }
                } else if (message.type === 'file-complete') {
                    const file = fileChunks[message.name];
                    if (file) {
                        const blob = new Blob(file.chunks);
                        addReceivedFile(message.name, blob, file.size);

                        stats.receivedCount++;
                        stats.totalReceived += file.size;
                        updateStats();

                        delete fileChunks[message.name];
                    }
                }
            } catch (error) {
                console.error('Error handling incoming data:', error);
            }
        }

        function addReceivedFile(name, blob, size) {
            document.getElementById('receivedFiles').classList.remove('hidden');
            const receivedList = document.getElementById('receivedList');

            const div = document.createElement('div');
            div.className = 'file-item bg-white p-3 rounded-lg flex items-center justify-between border border-gray-200';
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-file-download text-2xl text-green-500"></i>
                    <div>
                        <div class="font-medium text-gray-800">${name}</div>
                        <div class="text-sm text-gray-500">${formatFileSize(size)}</div>
                    </div>
                </div>
                <button onclick="downloadFile('${name}', ${receivedFiles.length})" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors">
                    <i class="fas fa-download mr-1"></i>Download
                </button>
            `;
            receivedList.appendChild(div);

            receivedFiles.push({ name, blob, size });
        }

        window.downloadFile = function(name, index) {
            const file = receivedFiles[index];
            if (file) {
                const url = URL.createObjectURL(file.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
